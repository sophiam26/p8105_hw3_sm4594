---
title: "Data Science Homework #3"
author: "Sophia Miller"
date: "10/6/2019"
output: github_document
---

```{r setupcode, include=FALSE}
library(tidyverse)
library(viridis)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

# Problem 1
## Loading Instacart data

```{r load_instacart}
library(p8105.datasets)
data("instacart")
```

## Description of Instacart Dataset

The dataset used here is a cleaned and limited subset of the original Instacart data. Each row in this dataset represents a single product from an Instacart order. There are `r nrow(instacart)` rows and `r ncol(instacart)` columns in the dataset. Each observation has an order identifier (`order_id`), product identifier (`product_id`), and customer identifier (`user_id`). Key variables include `reordered`, which indicates  if the product has been ordered by the customer in the past month, `order_dow`, which indicates which day of the week the order was placed, `days_since_prior_order`, which indicates the number of days since the customer's last order, and `product_name`, which is the name of the product ordered. For example, the mean number of days between orders is `r round(mean(pull(instacart, days_since_prior_order)), 0)`, the mean hour of the day during which products from the ice cream aisle were ordered is `r round(mean(pull(filter(instacart, aisle == "ice cream ice"), order_hour_of_day)), 0)` (2:00PM), and the total number of products ordered from the "specialty cheeses" aisle in the dataset is `r nrow(filter(instacart, aisle == "specialty cheeses"))`.

## Exploratory data analysis of Instacart data

There are `r nrow(distinct(instacart, aisle))` aisles in the dataset, and the most items are ordered from the "`r names(which.max(table(pull(instacart, aisle)))) ## change this to top three?`" aisle.

### The following plot shows the numbers of items ordered from each aisle (limited to aisles with more than 10,000 items ordered):

```{r aisle_plot}
instacart %>% 
  group_by(aisle) %>% 
  summarize(
    n_items_ordered = n()) %>% 
  mutate(aisle = reorder(aisle, n_items_ordered)) %>% 
  filter(n_items_ordered > 10000) %>% 
  ggplot(aes(x = aisle, y = n_items_ordered)) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) + geom_col() + ggtitle("Figure 1. Number of items ordered per aisle") + theme(plot.title = element_text(hjust = 0.5))

## comment on results of this and other tables/figures??
```


### The following table shows the three most popular items in the "baking ingredients", "dog food care", and "packaged fruits and vegetables" aisles:

```{r popular_items}
instacart %>% 
  group_by(product_name, aisle) %>%
  summarize(
    n_items_ordered = n()
    ) %>% 
  group_by(aisle) %>% 
  filter(
    aisle %in% c("baking ingredients","dog food care", "packaged vegetables fruits"),
    min_rank(desc(n_items_ordered)) < 4) %>% 
  arrange(n_items_ordered, aisle) %>% 
  knitr::kable(format = 'pandoc', caption = "Table 1. Most popular items by aisle")
```


### The following table shows the mean time of day that pink lady apples and coffee ice cream were ordered on each day of the week:

```{r time_of_day_table}
instacart %>% 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>% 
  mutate(order_dow = as.factor(order_dow)) %>% 
  arrange(order_dow) %>% 
  mutate(Day = recode(order_dow, '0' = "Sunday", '1' = "Monday", '2' = "Tuesday", '3' = "Wednesday", '4' = "Thursday", '5' = "Friday", '6' = "Saturday")) %>% 
  group_by(product_name, Day) %>% 
  summarize(mean_hour = mean(order_hour_of_day)) %>% 
  pivot_wider(
    names_from = product_name,
    values_from = mean_hour) %>% 
  knitr::kable(format = 'pandoc', caption = "Table 2. Mean hour of day of item order, by day of week", digits = 0)

## convert hour to time variable, convert day number to day name directly
```

# Problem 2
## Loading BRFSS data

```{r load_brfss}
library(p8105.datasets)
data("brfss_smart2010") 
```

## Cleaning BRFSS data

```{r clean_brfss}
brfss_data = brfss_smart2010 %>% 
  janitor::clean_names() %>% 
  separate(locationdesc, c("state", "county")) %>% 
  filter(topic == "Overall Health") %>% 
  mutate(response = 
           factor(response, c("Poor", "Fair", "Good", "Very good", "Excellent"))) %>% 
  select(-locationabbr)
```

## Exploratory data analysis of BRFSS data
### Which states were observed at 7 or more locations?
```{r common_states}
brfss_data %>% 
  filter(year == "2002") %>% 
  group_by(state) %>% 
  summarize(
  n_counties = n_distinct(county)) %>% 
  filter(n_counties >= 7) %>% 
knitr::kable(format = 'pandoc', caption = "Table 3. States observed in 7 or more counties")
```

```{r common_states2}
brfss_data %>% 
  filter(year == "2010") %>% 
  group_by(state) %>% 
  summarize(
  n_counties = n_distinct(county)) %>% 
  filter(n_counties >= 7) %>% 
knitr::kable(format = 'pandoc', caption = "Table 4. States observed in 7 or more counties")
```

## BRFSS Subset

```{r brfss_subset}
brfss_subset = brfss_data %>% 
  filter(response == "Excellent") %>% 
    select(year, state, data_value) %>%
  group_by(state, year) %>%
  mutate(mean_data_value = mean(data_value, na.rm = TRUE)) %>% 
  select(-data_value) %>% 
  distinct(.keep_all = TRUE)

ggplot(brfss_subset, aes(x = year, y = mean_data_value)) + geom_line(aes(group = state, color = state))
```

## Two-panel plot

```{r brfss_plot}
brfss_data %>% 
  filter(year %in% c("2006", "2010")) %>%
  select(year, state, response, data_value) %>%
  ggplot(aes(x = response, y = data_value)) + geom_boxplot(aes(color = response)) + facet_grid(~year)
```

# Problem 3
## Load and clean accelerometer data

```{r accel}
accel_data = read_csv(file = "./data/accel_data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(weekday = day,
         weekday = recode(weekday, "Monday" = "Weekday", "Tuesday" = "Weekday", "Wednesday" = "Weekday", "Thursday" = "Weekday", "Friday" = "Weekday", "Saturday" = "Weekend", "Sunday" = "Weekend"))

## take out original day variable? better way to recode weekday? what are variable classes?
```

```{r total_activity}
accel_total_activity = accel_data %>% 
  mutate(total_activity = rowSums(select(., starts_with("activity"))))
```

```{r total_activity_table}
accel_total = accel_data %>% 
  mutate(total_activity = rowSums(select(., starts_with("activity")))) %>% 
  select(week, day_id, day, weekday, total_activity) %>%
  knitr::kable(format = 'pandoc', caption = "Table 5. Total Activity")

#which variables should be included in addition to total_activity? Should we just observe trends or do an analysis?
```

